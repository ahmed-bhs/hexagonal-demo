deptrac:
  paths:
    - ./src
  exclude_files:
    - '#.*test.*#i'

  layers:
    # 0a. Shared Domain - Code métier partagé (concepts DDD purs)
    - name: SharedDomain
      collectors:
        - type: classLike
          value: App\\Shared\\Domain\\.*

    # 0b. Shared Infrastructure - Code technique partagé
    - name: SharedInfrastructure
      collectors:
        - type: classLike
          value: App\\Shared\\Infrastructure\\.*

    # 1. Domain Layer - Le coeur métier pur (bounded context specific)
    - name: Domain
      collectors:
        - type: classLike
          value: App\\Cadeau\\.*\\Domain\\.*

    # 2. Application Layer - Cas d'usage (CQRS: Commands & Queries)
    - name: Application
      collectors:
        - type: classLike
          value: App\\Cadeau\\.*\\Application\\.*

    # 3. Infrastructure Layer - Adaptateurs techniques (Doctrine, etc.)
    - name: Infrastructure
      collectors:
        - type: classLike
          value: App\\Cadeau\\.*\\Infrastructure\\.*

    # 4. UI Layer - Présentation (Controllers, Forms, etc.)
    - name: UI
      collectors:
        - type: classLike
          value: App\\Cadeau\\.*\\UI\\.*

    # 5. Symfony Framework (Controllers globaux, DataFixtures, etc.)
    - name: Symfony
      collectors:
        - type: classLike
          value: App\\Controller\\.*
        - type: classLike
          value: App\\DataFixtures\\.*
        - type: classLike
          value: App\\Kernel

  ruleset:
    # ================================================================================
    # ARCHITECTURE HEXAGONALE - RÈGLES DE DÉPENDANCES
    # IMPORTANT : Dans Deptrac, on liste les dépendances AUTORISÉES
    # Si une couche n'est pas listée = elle est INTERDITE
    # ================================================================================

    # Shared Domain - ✅ Ne dépend de PERSONNE (concepts DDD purs)
    SharedDomain: []

    # Shared Infrastructure - ✅ Peut dépendre de SharedDomain uniquement
    SharedInfrastructure:
      - SharedDomain  # Implémente les ports du Shared Domain

    # Domain Layer - ✅ Peut UNIQUEMENT dépendre de SharedDomain
    # ⚠️ IMPORTANT: Domain ne peut PAS dépendre de SharedInfrastructure !
    Domain:
      - SharedDomain  # Domain PEUT utiliser concepts DDD partagés (AggregateRoot, DomainEvent)

    # Application Layer - ✅ Peut dépendre de Domain et SharedDomain
    Application:
      - Domain        # Application PEUT dépendre de Domain (Ports, Models, ValueObjects)
      - SharedDomain  # Application PEUT utiliser SharedDomain (DomainEventPublisher port)

    # Infrastructure Layer - ✅ Peut dépendre de Domain, SharedDomain, SharedInfrastructure
    Infrastructure:
      - Domain               # Infrastructure PEUT dépendre de Domain (implémente les Ports)
      - SharedDomain         # Infrastructure PEUT utiliser SharedDomain (ports)
      - SharedInfrastructure # Infrastructure PEUT utiliser SharedInfrastructure (adapters)

    # UI Layer - ✅ Peut dépendre de Application et Symfony
    # Ne peut PAS dépendre directement de Domain ou Infrastructure
    UI:
      - Application  # UI PEUT dépendre d'Application (Commands, Queries, Responses)
      - Symfony      # UI PEUT utiliser Symfony (Forms, Controllers, etc.)

    # Symfony Layer - ✅ Peut dépendre de Domain, Application, Infrastructure, Shared
    #
    # JUSTIFICATION : Les DataFixtures sont un cas spécial acceptable
    # - Ce sont des données de test/seed, pas du code métier
    # - Elles doivent créer des entités Domain directement
    # - Alternative : créer des Commands spécifiques → complexité inutile
    #
    # IMPORTANT : Les Controllers (HomeController, etc.) respectent CQRS
    # et passent par Application, ils n'accèdent PAS directement au Domain
    Symfony:
      - Domain               # Pour DataFixtures uniquement (données de test)
      - Application          # Pour Controllers (CQRS)
      - Infrastructure       # Pour configuration Doctrine, services
      - SharedDomain         # Peut utiliser Shared Domain
      - SharedInfrastructure # Peut utiliser Shared Infrastructure

  formatters:
    graphviz:
      # Génère un graphique visuel des dépendances entre layers
      groups:
        Domain:
          - Domain
        Application:
          - Application
        Infrastructure:
          - Infrastructure
        UI:
          - UI
        Framework:
          - Symfony
